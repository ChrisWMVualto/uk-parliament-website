<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>OpenTelly HLS-player</title>
    <style>
        #player, .video-player {
            width: 853px;
            height: 480px;
        }
    </style>

    <link href="css/player.css" rel="stylesheet">
    </head>
    <body>
        <video class="video-player" src="http://10.196.50.54/live/6697bc05-1195-42c3-aa24-0133c70f2a67/live.isml/live.m3u8" preload="none" controls="controls"></video>

        <div class="description">
            The current program-date-time is: <span id="currentProgramDateTime" style="color: #f00;">empty</span><br />
        </div>

        <script>
            theoplayer = {
                configuration : {
                    allowManualQualitySwitch : true
                }
            };
        </script>

        <script type="text/javascript" src="http://cdn.theoplayer.com/60ddaae0-2c60-11e4-8c21-0800200c9a66.js"></script>

        <script>
            Node.prototype.addClass = function(className) {
                this.classList.add(className);
                return this;
            }

            Node.prototype.addAttr = function(key, value) {
                this.setAttribute(key, value);
                return this;
            }

            Node.prototype.injectTooltip = function(tooltip) {
                return this.addAttr('title', tooltip);
            }

            Node.prototype.readTooltip = function() {
                return this.getAttribute('title');
            }

            function theoplayerOverrides() {}

            theoplayerOverrides.prototype = {
                init: function() {

                },
                playTime: function(date) {
                    var timestring = ("0" + date.getHours()).slice(-2);
                    timestring += ':';
                    timestring += ("0" + date.getMinutes()).slice(-2);
                    timestring += ':';
                    timestring += ("0" + date.getSeconds()).slice(-2);

                    var timeContainers = document.getElementsByClassName('vjs-current-time vjs-time-controls')[0].getElementsByClassName('vjs-current-time-display');
                    if (timeContainers.length === 1) {
                        var replacement = document.createElement('div').addClass('vjs-current-time-display').addClass('override-replacement').addAttr('aria-live', 'off');
                        document.getElementsByClassName('vjs-current-time vjs-time-controls')[0].appendChild(replacement);
                        timeContainers[0].addAttr('style', 'display: none;');
                        timeContainers = document.getElementsByClassName('vjs-current-time-display');
                    }

                    timeContainers[1].textContent = timestring;
                },
                qualitySettings: function() {
                    var that = this,
                        qualitySettingNames = [
                            'Very High',
                            'High',
                            'Medium',
                            'Low'
                        ];

                    try {
                        var qualitySettings = document.querySelector('.theoplayer').querySelector('.theoplayer-resolution-button').querySelector('.vjs-menu-content').getElementsByTagName('li');
                        if (typeof qualitySettings != 'undefined') {
                            window.console && console.log(qualitySettings);

                            if (qualitySettings.length == 0)
                                throw('Exception');

                            if (qualitySettings.length == 4)
                                iQualitySettingName = 1;
                            else if (qualitySettings.length == 3)
                                iQualitySettingName = 0;

                            for (var i = 0; i < qualitySettings.length; i++) {
                                if (qualitySettings[i].innerText != 'auto') {
                                    qualitySettings[i].innerText = qualitySettingNames[iQualitySettingName];
                                    iQualitySettingName++;
                                }
                            }

                            return;
                        }
                        throw('Exception');
                    }
                    catch(e) {
                        window.setTimeout(that.qualitySettings, 50);
                    }
                },
            }

            var downloadControl;
            setTimeout(function () {
                var container = document.getElementById('currentProgramDateTime'),
                    player = theoplayer.players[0],
                    override = new theoplayerOverrides(),
                    selectors = {
                        buttons: {
                            play: document.querySelector('.vjs-play-control'),
                            quality: document.querySelector('.theoplayer-resolution-button'),
                            mute: document.querySelector('.vjs-mute-control'),
                            fullscreen: document.querySelector('.vjs-fullscreen-control')
                        }
                    };


                player.addEventListener('timeupdate', function () {
                    container.innerHTML = JSON.stringify(player.currentProgramDateTime);
                });

                player.addEventListener('play', function() {
                    override.qualitySettings();
                    selectors.buttons.play.injectTooltip('Pause clip');
                });

                player.addEventListener('playing', function() {
                    override.qualitySettings();
                    selectors.buttons.play.injectTooltip('Pause clip');

                    //TODO: REMOVE TEMP HACK
                    var initEvent = new Event('initialized');
                    player.dispatchEvent(initEvent);
                });

                player.addEventListener('qualityChanged', function() {
                    override.qualitySettings();
                });

                player.addEventListener('pause', function() {
                    override.qualitySettings();
                    selectors.buttons.play.injectTooltip('Play clip');
                });

                player.addEventListener('initialized', function() {
                    selectors.buttons.fullscreen.injectTooltip('Fullscreen');

                    var volEvent = new Event('volumechange');
                    player.dispatchEvent(volEvent);
                });

                player.addEventListener('volumechange', function() {
                    var button = selectors.buttons.mute;

                    if (button.classList.contains('vjs-vol-0')) {
                        button.injectTooltip('Unmute');
                    } else {
                        button.injectTooltip('Mute');
                    }
                });

                // TODO: Currently dependent on video having started playing as initialized event now thrown by theo
                // Temp workaround.
                selectors.buttons.fullscreen.addEventListener('mousedown', function() {
                    var tip = 'Fullscreen';

                    if (selectors.buttons.fullscreen.readTooltip() == 'Fullscreen')
                        tip = 'Exit fullscreen';

                    selectors.buttons.fullscreen.injectTooltip(tip);
                });

                player.play();

                // In order to seek to a specific program-date-time, you can set a date-object on the currentProgramDateTime-property:
                //player.currentProgramDateTime = new Date('2014-10-24T09:01:23+02:00');
                override.playTime(new Date());
                override.qualitySettings();
            }, 500);
        </script>
    </body>
</html>
